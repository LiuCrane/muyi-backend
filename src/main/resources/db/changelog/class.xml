<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">
    <changeSet id="class" author="Ivan Su">
        <createTable tableName="class" remarks="班级">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(128)" remarks="班级名称">
                <constraints nullable="false"/>
            </column>
            <column name="teacher" type="VARCHAR(128)" remarks="老师">
                <constraints nullable="false"/>
            </column>
            <column name="store_id" type="BIGINT UNSIGNED" remarks="门店id">
                <constraints nullable="false"/>
            </column>
            <column name="study_progress" type="VARCHAR(16)" defaultValue="NOT_STARTED"
                    remarks="学习进度(NOT_STARTED:未开始,IN_PROGRESS:进行中,ENDED:已结束)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueNumeric="1" name="active" type="TINYINT(3) UNSIGNED"/>
            <column defaultValueComputed="current_timestamp()" name="created_at" type="datetime"/>
            <column name="created_by" type="VARCHAR(255)"/>
            <column defaultValueComputed="NULL" name="updated_at" type="datetime"/>
            <column name="updated_by" type="VARCHAR(255)"/>
        </createTable>
        <createIndex indexName="idx_name" tableName="class">
            <column name="name"/>
        </createIndex>
        <createIndex indexName="idx_active" tableName="class">
            <column name="active"/>
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="store_id" baseTableName="class" constraintName="fk_class_store_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="store" validate="true"/>
    </changeSet>
    <changeSet id="update study_progress column's remark" author="Ivan Su">
        <setColumnRemarks tableName="class" columnName="study_progress" columnDataType="VARCHAR(16)"
                          remarks="学习进度(NOT_STARTED:未开始,IN_PROGRESS:进行中,REHAB_TRAINING:复训中,ENDED:已结束)"/>
    </changeSet>
    <changeSet id="set default value for study_progress" author="Ivan Su">
        <addDefaultValue tableName="class" columnName="study_progress" defaultValue="NOT_STARTED"/>
    </changeSet>

    <changeSet id="class_course" author="Ivan Su">
        <createTable tableName="class_course" remarks="班级课程">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="class_id" type="BIGINT UNSIGNED" remarks="班级id">
                <constraints nullable="false"/>
            </column>
            <column name="course_id" type="BIGINT UNSIGNED" remarks="课程id">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(16)"
                    remarks="状态(APPLICABLE:可申请,UN_APPLICABLE:不可申请,UNDER_APPLICATION:申请中,ACCESSIBLE:可进入课程,COMPLETED:已完成)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="current_timestamp()" name="created_at" type="datetime"/>
            <column name="created_by" type="VARCHAR(255)"/>
            <column defaultValueComputed="NULL" name="updated_at" type="datetime"/>
            <column name="updated_by" type="VARCHAR(255)"/>
        </createTable>
        <addUniqueConstraint tableName="class_course" constraintName="uni_ci_ci" columnNames="class_id,course_id"/>
        <addForeignKeyConstraint baseColumnNames="class_id" baseTableName="class_course" constraintName="fk_cc_class_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="class" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="course_id" baseTableName="class_course"
                                 constraintName="fk_cc_course_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="course" validate="true"/>
    </changeSet>
    <changeSet id="change status field's length of class_course table" author="Ivan Su">
        <dropColumn tableName="class_course" columnName="status"/>
        <addColumn tableName="class_course">
            <column name="status" type="VARCHAR(20)"
                    remarks="状态(APPLICABLE:可申请,UN_APPLICABLE:不可申请,UNDER_APPLICATION:申请中,ACCESSIBLE:可进入课程,COMPLETED:已完成)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="class_course_application" author="Ivan Su">
        <createTable tableName="class_course_application" remarks="课程申请">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="class_course_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="result" type="TINYINT(3) UNSIGNED" remarks="审核结果(1:同意, 0:拒绝)"/>
            <column defaultValueComputed="current_timestamp()" name="created_at" type="datetime"/>
            <column name="created_by" type="VARCHAR(255)"/>
            <column defaultValueComputed="NULL" name="updated_at" type="datetime"/>
            <column name="updated_by" type="VARCHAR(255)"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="class_course_id" baseTableName="class_course_application"
                                 constraintName="fk_cca_class_course_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="class_course" validate="true"/>
    </changeSet>

    <changeSet id="class_course_media" author="Ivan Su">
        <createTable tableName="class_course_media">
            <column autoIncrement="true" name="id" type="BIGINT UNSIGNED">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="class_course_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="media_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="player_event" type="VARCHAR(8)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="class_course_id" baseTableName="class_course_media"
                                 constraintName="fk_ccm_class_course_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="class_course" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="media_id" baseTableName="class_course_media"
                                 constraintName="fk_ccm_media_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="media" validate="true"/>
    </changeSet>
    <changeSet id="rename table class_course_media to class_course_event" author="Ivan Su">
        <renameTable oldTableName="class_course_media" newTableName="class_course_event" />
    </changeSet>

    <changeSet id="change fk for class_course_media" author="Ivan Su">
        <dropForeignKeyConstraint baseTableName="class_course_media" constraintName="fk_ccm_media_id"/>
        <addForeignKeyConstraint baseColumnNames="media_id" baseTableName="class_course_media"
                                 constraintName="fk_ccm_media_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="CASCADE"
                                 referencedColumnNames="id" referencedTableName="media" validate="true"/>
    </changeSet>
</databaseChangeLog>