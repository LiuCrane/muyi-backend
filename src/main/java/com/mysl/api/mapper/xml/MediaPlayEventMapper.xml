<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mysl.api.mapper.MediaPlayEventMapper">
    <select id="getEvent" resultType="com.mysl.api.entity.MediaPlayEvent">
        SELECT * FROM media_play_event
        <where>
            !recorded
            <if test="class_course_id != null">
                AND class_course_id = #{class_course_id}
            </if>
            AND media_id = #{media_id}
            AND player_event = #{event}
            AND user_id = #{user_id}
            ORDER BY created_at
            <if test="desc != null">
                desc
            </if>
            LIMIT 1
        </where>
    </select>

    <update id="updateRecorded">
        UPDATE media_play_event
        SET recorded = 1
        <where>
            !recorded
            <if test="class_course_id != null">
                AND class_course_id = #{class_course_id}
            </if>
            AND media_id = #{media_id}
            AND user_id = #{user_id}
        </where>
    </update>

    <select id="countEndedMedia" resultType="java.lang.Integer">
        SELECT COUNT(id) FROM media_play_event
        WHERE store_id = #{store_id} AND media_id = #{media_id} AND player_event = 'END'
        AND class_course_id = #{class_course_id} AND TO_DAYS(created_at) = TO_DAYS(NOW())
        AND created_at > (SELECT created_at FROM class_course_application
        WHERE class_course_id = #{class_course_id} AND result = 1 ORDER BY created_at DESC LIMIT 1)
    </select>
</mapper>
